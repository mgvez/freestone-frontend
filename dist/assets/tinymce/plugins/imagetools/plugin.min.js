!function(){"use strict";var t=function(n){var e=n,o=function(){return e};return{get:o,set:function(t){e=t},clone:function(){return t(o())}}},n=tinymce.util.Tools.resolve("tinymce.PluginManager"),e=tinymce.util.Tools.resolve("tinymce.util.Tools");function o(t,n){return i(document.createElement("canvas"),t,n)}function r(t){return t.getContext("2d")}function i(t,n,e){return t.width=n,t.height=e,t}var a,u,c,l,s={create:o,clone:function(t){var n;return r(n=o(t.width,t.height)).drawImage(t,0,0),n},resize:i,get2dContext:r,get3dContext:function(t){var n=null;try{n=t.getContext("webgl")||t.getContext("experimental-webgl")}catch(t){}return n||(n=null),n}},f=function(t){return t.naturalWidth||t.width},d=function(t){return t.naturalHeight||t.height},h=window.Promise?window.Promise:function(){var t=function(t){if("object"!=typeof this)throw new TypeError("Promises must be constructed via new");if("function"!=typeof t)throw new TypeError("not a function");this._state=null,this._value=null,this._deferreds=[],c(t,e(i,this),e(a,this))},n=t.immediateFn||"function"==typeof setImmediate&&setImmediate||function(t){setTimeout(t,1)};function e(t,n){return function(){t.apply(n,arguments)}}var o=Array.isArray||function(t){return"[object Array]"===Object.prototype.toString.call(t)};function r(t){var e=this;null!==this._state?n((function(){var n=e._state?t.onFulfilled:t.onRejected;if(null!==n){var o;try{o=n(e._value)}catch(n){return void t.reject(n)}t.resolve(o)}else(e._state?t.resolve:t.reject)(e._value)})):this._deferreds.push(t)}function i(t){try{if(t===this)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var n=t.then;if("function"==typeof n)return void c(e(n,t),e(i,this),e(a,this))}this._state=!0,this._value=t,u.call(this)}catch(t){a.call(this,t)}}function a(t){this._state=!1,this._value=t,u.call(this)}function u(){for(var t=0,n=this._deferreds.length;t<n;t++)r.call(this,this._deferreds[t]);this._deferreds=null}function c(t,n,e){var o=!1;try{t((function(t){o||(o=!0,n(t))}),(function(t){o||(o=!0,e(t))}))}catch(t){if(o)return;o=!0,e(t)}}return t.prototype.catch=function(t){return this.then(null,t)},t.prototype.then=function(n,e){var o=this;return new t((function(t,i){r.call(o,new function(t,n,e,o){this.onFulfilled="function"==typeof t?t:null,this.onRejected="function"==typeof n?n:null,this.resolve=e,this.reject=o}(n,e,t,i))}))},t.all=function(){var n=Array.prototype.slice.call(1===arguments.length&&o(arguments[0])?arguments[0]:arguments);return new t((function(t,e){if(0===n.length)return t([]);var o=n.length;function r(i,a){try{if(a&&("object"==typeof a||"function"==typeof a)){var u=a.then;if("function"==typeof u)return void u.call(a,(function(t){r(i,t)}),e)}n[i]=a,0==--o&&t(n)}catch(t){e(t)}}for(var i=0;i<n.length;i++)r(i,n[i])}))},t.resolve=function(n){return n&&"object"==typeof n&&n.constructor===t?n:new t((function(t){t(n)}))},t.reject=function(n){return new t((function(t,e){e(n)}))},t.race=function(n){return new t((function(t,e){for(var o=0,r=n.length;o<r;o++)n[o].then(t,e)}))},t}(),p=function(t){return function(){return t}},m={noop:function(){},noarg:function(t){return function(){return t()}},compose:function(t,n){return function(){return t(n.apply(null,arguments))}},constant:p,identity:function(t){return t},tripleEquals:function(t,n){return t===n},curry:function(t){for(var n=new Array(arguments.length-1),e=1;e<arguments.length;e++)n[e-1]=arguments[e];return function(){for(var e=new Array(arguments.length),o=0;o<e.length;o++)e[o]=arguments[o];var r=n.concat(e);return t.apply(null,r)}},not:function(t){return function(){return!t.apply(null,arguments)}},die:function(t){return function(){throw new Error(t)}},apply:function(t){return t()},call:function(t){t()},never:p(!1),always:p(!0)},g=m.never,v=m.always,y=function(){return b},b=(l={fold:function(t,n){return t()},is:g,isSome:g,isNone:v,getOr:c=function(t){return t},getOrThunk:u=function(t){return t()},getOrDie:function(t){throw new Error(t||"error: getOrDie called on none.")},or:c,orThunk:u,map:y,ap:y,each:function(){},bind:y,flatten:y,exists:g,forall:v,filter:y,equals:a=function(t){return t.isNone()},equals_:a,toArray:function(){return[]},toString:m.constant("none()")},Object.freeze&&Object.freeze(l),l),w=function(t){var n=function(){return t},e=function(){return r},o=function(n){return n(t)},r={fold:function(n,e){return e(t)},is:function(n){return t===n},isSome:v,isNone:g,getOr:n,getOrThunk:n,getOrDie:n,or:e,orThunk:e,map:function(n){return w(n(t))},ap:function(n){return n.fold(y,(function(n){return w(n(t))}))},each:function(n){n(t)},bind:o,flatten:n,exists:o,forall:o,filter:function(n){return n(t)?r:b},equals:function(n){return n.is(t)},equals_:function(n,e){return n.fold(g,(function(n){return e(t,n)}))},toArray:function(){return[t]},toString:function(){return"some("+t+")"}};return r},x={some:w,none:y,from:function(t){return null==t?b:w(t)}},k="undefined"!=typeof window?window:Function("return this;")(),R=function(t,n){var e=function(t,n){return function(t,n){for(var e=null!=n?n:k,o=0;o<t.length&&null!=e;++o)e=e[t[o]];return e}(t.split("."),n)}(t,n);if(null==e)throw t+" not available on this browser";return e};function T(){return new(R("FileReader"))}function I(t){return new h((function(n,e){var o=URL.createObjectURL(t),r=new Image,i=function(){r.removeEventListener("load",a),r.removeEventListener("error",u)};function a(){i(),n(r)}function u(){i(),e("Unable to load data of type "+t.type+": "+o)}r.addEventListener("load",a),r.addEventListener("error",u),r.src=o,r.complete&&a()}))}function C(t){return new h((function(n,e){var o=new XMLHttpRequest;o.open("GET",t,!0),o.responseType="blob",o.onload=function(){200==this.status&&n(this.response)},o.onerror=function(){var t;e(0===this.status?((t=new Error("No access to download image")).code=18,t.name="SecurityError",t):new Error("Error "+this.status+" downloading image"))},o.send()}))}function M(t){var n=t.split(","),e=/data:([^;]+)/.exec(n[0]);if(!e)return x.none();for(var o,r,i,a=e[1],u=function(t){return R("atob")(t)}(n[1]),c=u.length,l=Math.ceil(c/1024),s=new Array(l),f=0;f<l;++f){for(var d=1024*f,h=Math.min(d+1024,c),p=new Array(h-d),m=d,g=0;m<h;++g,++m)p[g]=u[m].charCodeAt(0);s[f]=(o=p,new(R("Uint8Array"))(o))}return x.some((r=s,i={type:a},new(R("Blob"))(r,i)))}function B(t){return new h((function(n,e){M(t).fold((function(){e("uri is not base64: "+t)}),n)}))}function A(t){return new h((function(n){var e=new T;e.onloadend=function(){n(e.result)},e.readAsDataURL(t)}))}var U={blobToImage:I,imageToBlob:function(t){return(n=t,new h((function(t){n.complete?t(n):n.addEventListener("load",(function e(){n.removeEventListener("load",e),t(n)}))}))).then((function(t){var n=t.src;return 0===n.indexOf("blob:")?C(n):0===n.indexOf("data:")?B(n):C(n)}));var n},blobToArrayBuffer:function(t){return new h((function(n){var e=new T;e.onloadend=function(){n(e.result)},e.readAsArrayBuffer(t)}))},blobToDataUri:A,blobToBase64:function(t){return A(t).then((function(t){return t.split(",")[1]}))},dataUriToBlobSync:M,canvasToBlob:function(t,n,e){return n=n||"image/png",HTMLCanvasElement.prototype.toBlob?new h((function(o){t.toBlob((function(t){o(t)}),n,e)})):B(t.toDataURL(n,e))},canvasToDataURL:function(t,n,e){return n=n||"image/png",t.then((function(t){return t.toDataURL(n,e)}))},blobToCanvas:function(t){return I(t).then((function(t){var n,e;return n=t,URL.revokeObjectURL(n.src),e=s.create(f(t),d(t)),s.get2dContext(e).drawImage(t,0,0),e}))},uriToBlob:function(t){return 0===t.indexOf("blob:")?C(t):0===t.indexOf("data:")?B(t):null}};function E(t,n,e){var o=n.type;function r(n,e){return t.then((function(t){return U.canvasToDataURL(t,n,e)}))}return{getType:m.constant(o),toBlob:function(){return h.resolve(n)},toDataURL:function(){return e},toBase64:function(){return e.split(",")[1]},toAdjustedBlob:function(n,e){return t.then((function(t){return U.canvasToBlob(t,n,e)}))},toAdjustedDataURL:r,toAdjustedBase64:function(t,n){return r(t,n).then((function(t){return t.split(",")[1]}))},toCanvas:function(){return t.then(s.clone)}}}function _(t){return U.blobToDataUri(t).then((function(n){return E(U.blobToCanvas(t),t,n)}))}var z={fromBlob:_,fromCanvas:function(t,n){return U.canvasToBlob(t,n).then((function(n){return E(h.resolve(t),n,t.toDataURL())}))},fromImage:function(t){return U.imageToBlob(t).then((function(t){return _(t)}))},fromBlobAndUrlSync:function(t,n){return E(U.blobToCanvas(t),t,n)}};function D(t,n,e){return(t=parseFloat(t))>e?t=e:t<n&&(t=n),t}var L=[0,.01,.02,.04,.05,.06,.07,.08,.1,.11,.12,.14,.15,.16,.17,.18,.2,.21,.22,.24,.25,.27,.28,.3,.32,.34,.36,.38,.4,.42,.44,.46,.48,.5,.53,.56,.59,.62,.65,.68,.71,.74,.77,.8,.83,.86,.89,.92,.95,.98,1,1.06,1.12,1.18,1.24,1.3,1.36,1.42,1.48,1.54,1.6,1.66,1.72,1.78,1.84,1.9,1.96,2,2.12,2.25,2.37,2.5,2.62,2.75,2.87,3,3.2,3.4,3.6,3.8,4,4.3,4.7,4.9,5,5.5,6,6.5,6.8,7,7.3,7.5,7.8,8,8.4,8.7,9,9.4,9.6,9.8,10];function O(t,n){var e,o,r,i,a=[],u=new Array(10);for(e=0;e<5;e++){for(o=0;o<5;o++)a[o]=n[o+5*e];for(o=0;o<5;o++){for(i=0,r=0;r<5;r++)i+=t[o+5*r]*a[r];u[o+5*e]=i}}return u}function j(t,n){return n=D(n,0,1),t.map((function(t,e){return e%6==0?t=1-(1-t)*n:t*=n,D(t,0,1)}))}function H(t,n){return t.toCanvas().then((function(e){return o=e,r=t.getType(),i=n,a=function(t,n){var e,o,r,i,a,u=t.data,c=n[0],l=n[1],s=n[2],f=n[3],d=n[4],h=n[5],p=n[6],m=n[7],g=n[8],v=n[9],y=n[10],b=n[11],w=n[12],x=n[13],k=n[14],R=n[15],T=n[16],I=n[17],C=n[18],M=n[19];for(a=0;a<u.length;a+=4)e=u[a],o=u[a+1],r=u[a+2],i=u[a+3],u[a]=e*c+o*l+r*s+i*f+d,u[a+1]=e*h+o*p+r*m+i*g+v,u[a+2]=e*y+o*b+r*w+i*x+k,u[a+3]=e*R+o*T+r*I+i*C+M;return t}((u=s.get2dContext(o)).getImageData(0,0,o.width,o.height),i),u.putImageData(a,0,0),z.fromCanvas(o,r);var o,r,i,a,u}))}function F(t,n){return t.toCanvas().then((function(e){return o=e,r=t.getType(),i=n,a=function(t,n,e){var o,r,i,a,u,c,l,s,f,d,h,p,m,g,v,y;function b(t,n,e){return t>e?t=e:t<n&&(t=n),t}for(i=Math.round(Math.sqrt(e.length)),a=Math.floor(i/2),o=t.data,r=n.data,v=t.width,y=t.height,c=0;c<y;c++)for(u=0;u<v;u++){for(l=s=f=0,h=0;h<i;h++)for(d=0;d<i;d++)p=b(u+d-a,0,v-1),m=4*(b(c+h-a,0,y-1)*v+p),g=e[h*i+d],l+=o[m]*g,s+=o[m+1]*g,f+=o[m+2]*g;r[m=4*(c*v+u)]=b(l,0,255),r[m+1]=b(s,0,255),r[m+2]=b(f,0,255)}return n}((u=s.get2dContext(o)).getImageData(0,0,o.width,o.height),a=u.getImageData(0,0,o.width,o.height),i),u.putImageData(a,0,0),z.fromCanvas(o,r);var o,r,i,a,u}))}function S(t){return function(n,e){return n.toCanvas().then((function(o){return function(n,e,o){var r,i,a=s.get2dContext(n),u=new Array(256);for(i=0;i<u.length;i++)u[i]=t(i,o);return r=function(t,n){var e,o=t.data;for(e=0;e<o.length;e+=4)o[e]=n[o[e]],o[e+1]=n[o[e+1]],o[e+2]=n[o[e+2]];return t}(a.getImageData(0,0,n.width,n.height),u),a.putImageData(r,0,0),z.fromCanvas(n,e)}(o,n.getType(),e)}))}}function P(t){return function(n,e){return H(n,t([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],e))}}function V(t){return function(n){return F(n,t)}}var W,q={invert:(W=[-1,0,0,0,255,0,-1,0,0,255,0,0,-1,0,255,0,0,0,1,0],function(t){return H(t,W)}),brightness:P((function(t,n){return O(t,[1,0,0,0,n=D(255*n,-255,255),0,1,0,0,n,0,0,1,0,n,0,0,0,1,0,0,0,0,0,1])})),hue:P((function(t,n){var e,o,r,i,a;return n=D(n,-180,180)/180*Math.PI,O(t,[(r=.213)+.787*(e=Math.cos(n))+(o=Math.sin(n))*-r,(i=.715)+e*-i+o*-i,(a=.072)+e*-a+.928*o,0,0,r+e*-r+.143*o,i+e*(1-i)+.14*o,a+e*-a+-.283*o,0,0,r+e*-r+-.787*o,i+e*-i+o*i,a+.928*e+o*a,0,0,0,0,0,1,0,0,0,0,0,1])})),saturate:P((function(t,n){var e;return O(t,[.3086*(1-(e=1+((n=D(n,-1,1))>0?3*n:n)))+e,.6094*(1-e),.082*(1-e),0,0,.3086*(1-e),.6094*(1-e)+e,.082*(1-e),0,0,.3086*(1-e),.6094*(1-e),.082*(1-e)+e,0,0,0,0,0,1,0,0,0,0,0,1])})),contrast:P((function(t,n){var e;return n=D(n,-1,1),O(t,[(e=(n*=100)<0?127+n/100*127:127*(e=0==(e=n%1)?L[n]:L[Math.floor(n)]*(1-e)+L[Math.floor(n)+1]*e)+127)/127,0,0,0,.5*(127-e),0,e/127,0,0,.5*(127-e),0,0,e/127,0,.5*(127-e),0,0,0,1,0,0,0,0,0,1])})),grayscale:P((function(t,n){return O(t,j([.33,.34,.33,0,0,.33,.34,.33,0,0,.33,.34,.33,0,0,0,0,0,1,0,0,0,0,0,1],n=D(n,0,1)))})),sepia:P((function(t,n){return O(t,j([.393,.769,.189,0,0,.349,.686,.168,0,0,.272,.534,.131,0,0,0,0,0,1,0,0,0,0,0,1],n=D(n,0,1)))})),colorize:function(t,n,e,o){return H(t,function(t,n,e,o){return O(t,[n=D(n,0,2),0,0,0,0,0,e=D(e,0,2),0,0,0,0,0,o=D(o,0,2),0,0,0,0,0,1,0,0,0,0,0,1])}([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1],n,e,o))},sharpen:V([0,-1,0,-1,5,-1,0,-1,0]),emboss:V([-2,-1,0,-1,1,1,0,1,2]),gamma:S((function(t,n){return 255*Math.pow(t/255,1-n)})),exposure:S((function(t,n){return 255*(1-Math.exp(-t/255*n))})),colorFilter:H,convoluteFilter:F},N=function t(n,e,o){var r=f(n),i=d(n),a=e/r,u=o/i,c=!1;(a<.5||a>2)&&(a=a<.5?.5:2,c=!0),(u<.5||u>2)&&(u=u<.5?.5:2,c=!0);var l,p,m,g=(l=n,p=a,m=u,new h((function(t){var n=f(l),e=d(l),o=Math.floor(n*p),r=Math.floor(e*m),i=s.create(o,r);s.get2dContext(i).drawImage(l,0,0,n,e,0,0,o,r),t(i)})));return c?g.then((function(n){return t(n,e,o)})):g},$=function(t,n,e){return t.toCanvas().then((function(o){return N(o,n,e).then((function(n){return z.fromCanvas(n,t.getType())}))}))},X={invert:function(t){return q.invert(t)},sharpen:function(t){return q.sharpen(t)},emboss:function(t){return q.emboss(t)},brightness:function(t,n){return q.brightness(t,n)},hue:function(t,n){return q.hue(t,n)},saturate:function(t,n){return q.saturate(t,n)},contrast:function(t,n){return q.contrast(t,n)},grayscale:function(t,n){return q.grayscale(t,n)},sepia:function(t,n){return q.sepia(t,n)},colorize:function(t,n,e,o){return q.colorize(t,n,e,o)},gamma:function(t,n){return q.gamma(t,n)},exposure:function(t,n){return q.exposure(t,n)},flip:function(t,n){return function(t,n){return t.toCanvas().then((function(e){return o=e,r=t.getType(),i=n,a=s.create(o.width,o.height),u=s.get2dContext(a),"v"==i?(u.scale(1,-1),u.drawImage(o,0,-a.height)):(u.scale(-1,1),u.drawImage(o,-a.width,0)),z.fromCanvas(a,r);var o,r,i,a,u}))}(t,n)},crop:function(t,n,e,o,r){return function(t,n,e,o,r){return t.toCanvas().then((function(i){return a=i,u=t.getType(),c=n,l=e,f=o,d=r,h=s.create(f,d),s.get2dContext(h).drawImage(a,-c,-l),z.fromCanvas(h,u);var a,u,c,l,f,d,h}))}(t,n,e,o,r)},resize:function(t,n,e){return $(t,n,e)},rotate:function(t,n){return function(t,n){return t.toCanvas().then((function(e){return o=e,r=t.getType(),i=n,a=s.create(o.width,o.height),u=s.get2dContext(a),c=0,l=0,90!=(i=i<0?360+i:i)&&270!=i||s.resize(a,a.height,a.width),90!=i&&180!=i||(c=a.width),270!=i&&180!=i||(l=a.height),u.translate(c,l),u.rotate(i*Math.PI/180),u.drawImage(o,0,0),z.fromCanvas(a,r);var o,r,i,a,u,c,l}))}(t,n)}},Y=function(t){return z.fromBlob(t)},G=function(){return R("URL")},K=function(t){return G().createObjectURL(t)},J=function(t){G().revokeObjectURL(t)},Z=tinymce.util.Tools.resolve("tinymce.util.Delay"),Q=tinymce.util.Tools.resolve("tinymce.util.Promise"),tt=tinymce.util.Tools.resolve("tinymce.util.URI"),nt=tinymce.util.Tools.resolve("tinymce.dom.DOMUtils"),et=tinymce.util.Tools.resolve("tinymce.ui.Factory"),ot=tinymce.util.Tools.resolve("tinymce.geom.Rect"),rt=tinymce.util.Tools.resolve("tinymce.dom.DomQuery"),it=tinymce.util.Tools.resolve("tinymce.util.Observable"),at=tinymce.util.Tools.resolve("tinymce.util.VK"),ut=0;function ct(t){return{blob:t,url:K(t)}}function lt(t){t&&J(t.url)}function st(t){e.each(t,lt)}function ft(t,n,o,r){var i,a,u,c,l,s,f,d,h,p,m,g,v,y,b,w,x,k,R,T,I,C,M,B,A,U,E,_=function(){var t=[],n=-1;function e(){return n>0}function o(){return-1!==n&&n<t.length-1}return{data:t,add:function(e){var o;return o=t.splice(++n),t.push(e),{state:e,removed:o}},undo:function(){if(e())return t[--n]},redo:function(){if(o())return t[++n]},canUndo:e,canRedo:o}}(),z=function(n){return t.rtl?n.reverse():n};function D(t){var n,e,o,r;n=i.find("#w")[0],e=i.find("#h")[0],o=parseInt(n.value(),10),r=parseInt(e.value(),10),i.find("#constrain")[0].checked()&&B&&A&&o&&r&&("w"===t.control.settings.name?(r=Math.round(o*U),e.value(r)):(o=Math.round(r*E),n.value(o))),B=o,A=r}function L(t){return Math.round(100*t)+"%"}function O(){i.find("#undo").disabled(!_.canUndo()),i.find("#redo").disabled(!_.canRedo()),i.statusbar.find("#save").disabled(!_.canUndo())}function j(){i.find("#undo").disabled(!0),i.find("#redo").disabled(!0)}function H(t){t&&d.imageSrc(t.url)}function F(t){return function(){var n=e.grep(M,(function(n){return n.settings.name!==t}));e.each(n,(function(t){t.hide()})),t.show(),t.focus()}}function S(t){H(c=ct(t))}function P(t){H(n=ct(t)),st(_.add(n).removed),O()}function V(){var t=d.selection();Y(n.blob).then((function(n){X.crop(n,t.x,t.y,t.w,t.h).then(G).then((function(t){P(t),q()}))}))}var W=function(t){var e=[].slice.call(arguments,1);return function(){Y((c||n).blob).then((function(n){t.apply(this,[n].concat(e)).then(G).then(S)}))}};function q(){H(n),lt(c),F(a)(),O()}function N(){c?(P(c.blob),q()):function n(e,o){c?o():setTimeout((function(){e-- >0?n(e,o):t.windowManager.alert("Error: failed to apply image operation.")}),10)}(100,N)}function $(t){return et.create("Form",{layout:"flex",direction:"row",labelGap:5,border:"0 0 1 0",align:"center",pack:"center",padding:"0 10 0 10",spacing:5,flex:0,minHeight:60,defaults:{classes:"imagetool",type:"button"},items:t})}var G=function(t){return t.toBlob()};function K(t,e){return $(z([{text:"Back",onclick:q},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:N}])).hide().on("show",(function(){j(),Y(n.blob).then((function(t){return e(t)})).then(G).then((function(t){var n=ct(t);H(n),lt(c),c=n}))}))}function J(e,o,r,i,a){return $(z([{text:"Back",onclick:q},{type:"spacer",flex:1},{type:"slider",flex:1,ondragend:function(t){var e;e=t.value,Y(n.blob).then((function(t){return o(t,e)})).then(G).then((function(t){var n=ct(t);H(n),lt(c),c=n}))},minValue:t.rtl?a:i,maxValue:t.rtl?i:a,value:r,previewFilter:L},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:N}])).hide().on("show",(function(){this.find("slider").value(r),j()}))}l=$(z([{text:"Back",onclick:q},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:V}])).hide().on("show hide",(function(t){d.toggleCropRect("show"===t.type)})).on("show",j),s=$(z([{text:"Back",onclick:q},{type:"spacer",flex:1},{type:"textbox",name:"w",label:"Width",size:4,onkeyup:D},{type:"textbox",name:"h",label:"Height",size:4,onkeyup:D},{type:"checkbox",name:"constrain",text:"Constrain proportions",checked:!0,onchange:function(t){!0===t.control.value()&&(U=A/B,E=B/A)}},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:"submit"}])).hide().on("submit",(function(t){var e=parseInt(i.find("#w").value(),10),o=parseInt(i.find("#h").value(),10);t.preventDefault(),function(t){for(var e=[],o=1;o<arguments.length;o++)e[o-1]=arguments[o];var r=[].slice.call(arguments,1);return function(){Y(n.blob).then((function(n){t.apply(this,[n].concat(r)).then(G).then(P)}))}}(X.resize,e,o)(),q()})).on("show",j),f=$(z([{text:"Back",onclick:q},{type:"spacer",flex:1},{icon:"fliph",tooltip:"Flip horizontally",onclick:W(X.flip,"h")},{icon:"flipv",tooltip:"Flip vertically",onclick:W(X.flip,"v")},{icon:"rotateleft",tooltip:"Rotate counterclockwise",onclick:W(X.rotate,-90)},{icon:"rotateright",tooltip:"Rotate clockwise",onclick:W(X.rotate,90)},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:N}])).hide().on("show",j),m=K(0,X.invert),R=K(0,X.sharpen),T=K(0,X.emboss),g=J(0,X.brightness,0,-1,1),v=J(0,X.hue,180,0,360),y=J(0,X.saturate,0,-1,1),b=J(0,X.contrast,0,-1,1),w=J(0,X.grayscale,0,0,1),x=J(0,X.sepia,0,0,1),k=function(e,o){function r(){var t,e,r;t=i.find("#r")[0].value(),e=i.find("#g")[0].value(),r=i.find("#b")[0].value(),Y(n.blob).then((function(n){return o(n,t,e,r)})).then(G).then((function(t){var n=ct(t);H(n),lt(c),c=n}))}var a=t.rtl?2:0,u=t.rtl?0:2;return $(z([{text:"Back",onclick:q},{type:"spacer",flex:1},{type:"slider",label:"R",name:"r",minValue:a,value:1,maxValue:u,ondragend:r,previewFilter:L},{type:"slider",label:"G",name:"g",minValue:a,value:1,maxValue:u,ondragend:r,previewFilter:L},{type:"slider",label:"B",name:"b",minValue:a,value:1,maxValue:u,ondragend:r,previewFilter:L},{type:"spacer",flex:1},{text:"Apply",subtype:"primary",onclick:N}])).hide().on("show",(function(){i.find("#r,#g,#b").value(1),j()}))}(0,X.colorize),I=J(0,X.gamma,0,-1,1),C=J(0,X.exposure,1,0,2),u=$(z([{text:"Back",onclick:q},{type:"spacer",flex:1},{text:"hue",icon:"hue",onclick:F(v)},{text:"saturate",icon:"saturate",onclick:F(y)},{text:"sepia",icon:"sepia",onclick:F(x)},{text:"emboss",icon:"emboss",onclick:F(T)},{text:"exposure",icon:"exposure",onclick:F(C)},{type:"spacer",flex:1}])).hide(),a=$(z([{tooltip:"Crop",icon:"crop",onclick:F(l)},{tooltip:"Resize",icon:"resize2",onclick:F(s)},{tooltip:"Orientation",icon:"orientation",onclick:F(f)},{tooltip:"Brightness",icon:"sun",onclick:F(g)},{tooltip:"Sharpen",icon:"sharpen",onclick:F(R)},{tooltip:"Contrast",icon:"contrast",onclick:F(b)},{tooltip:"Color levels",icon:"drop",onclick:F(k)},{tooltip:"Gamma",icon:"gamma",onclick:F(I)},{tooltip:"Invert",icon:"invert",onclick:F(m)}])),d=function(t){return new(et.get("Control").extend({Defaults:{classes:"imagepanel"},selection:function(t){return arguments.length?(this.state.set("rect",t),this):this.state.get("rect")},imageSize:function(){var t=this.state.get("viewRect");return{w:t.w,h:t.h}},toggleCropRect:function(t){this.state.set("cropEnabled",t)},imageSrc:function(t){var n=this,e=new Image;e.src=t,function(t){return new Q((function(n){var e=function(){t.removeEventListener("load",e),n(t)};t.complete?n(t):t.addEventListener("load",e)}))}(e).then((function(){var t,o,r=n.state.get("viewRect");if((o=n.$el.find("img"))[0])o.replaceWith(e);else{var i=document.createElement("div");i.className="mce-imagepanel-bg",n.getEl().appendChild(i),n.getEl().appendChild(e)}t={x:0,y:0,w:e.naturalWidth,h:e.naturalHeight},n.state.set("viewRect",t),n.state.set("rect",ot.inflate(t,-20,-20)),r&&r.w===t.w&&r.h===t.h||n.zoomFit(),n.repaintImage(),n.fire("load")}))},zoom:function(t){return arguments.length?(this.state.set("zoom",t),this):this.state.get("zoom")},postRender:function(){return this.imageSrc(this.settings.imageSrc),this._super()},zoomFit:function(){var t,n,e,o,r,i;t=this.$el.find("img"),n=this.getEl().clientWidth,e=this.getEl().clientHeight,o=t[0].naturalWidth,r=t[0].naturalHeight,(i=Math.min((n-10)/o,(e-10)/r))>=1&&(i=1),this.zoom(i)},repaintImage:function(){var t,n,e,o,r,i,a,u,c,l,s;s=this.getEl(),c=this.zoom(),l=this.state.get("rect"),a=this.$el.find("img"),u=this.$el.find(".mce-imagepanel-bg"),r=s.offsetWidth,i=s.offsetHeight,e=a[0].naturalWidth*c,o=a[0].naturalHeight*c,t=Math.max(0,r/2-e/2),n=Math.max(0,i/2-o/2),a.css({left:t,top:n,width:e,height:o}),u.css({left:t,top:n,width:e,height:o}),this.cropRect&&(this.cropRect.setRect({x:l.x*c+t,y:l.y*c+n,w:l.w*c,h:l.h*c}),this.cropRect.setClampRect({x:t,y:n,w:e,h:o}),this.cropRect.setViewPortRect({x:0,y:0,w:r,h:i}))},bindStates:function(){var t=this;function n(n){t.cropRect=function(t,n,o,r,i){var a,u,c,l,s="mce-",f=s+"crid-"+ut++;function d(t,n){return{x:n.x-t.x,y:n.y-t.y,w:n.w,h:n.h}}function h(n,e,r,i){var u,c,l,s,f;u=e.x,c=e.y,l=e.w,s=e.h,u+=r*n.deltaX,c+=i*n.deltaY,(l+=r*n.deltaW)<20&&(l=20),(s+=i*n.deltaH)<20&&(s=20),f=t=ot.clamp({x:u,y:c,w:l,h:s},o,"move"===n.name),f=d(o,f),a.fire("updateRect",{rect:f}),g(f)}function p(t){function o(t,n){n.h<0&&(n.h=0),n.w<0&&(n.w=0),rt("#"+f+"-"+t,r).css({left:n.x,top:n.y,width:n.w,height:n.h})}e.each(u,(function(n){rt("#"+f+"-"+n.name,r).css({left:t.w*n.xMul+t.x,top:t.h*n.yMul+t.y})})),o("top",{x:n.x,y:n.y,w:n.w,h:t.y-n.y}),o("right",{x:t.x+t.w,y:t.y,w:n.w-t.x-t.w+n.x,h:t.h}),o("bottom",{x:n.x,y:t.y+t.h,w:n.w,h:n.h-t.y-t.h+n.y}),o("left",{x:n.x,y:t.y,w:t.x-n.x,h:t.h}),o("move",t)}function m(n){p(t=n)}function g(t){var n,e;m((n=o,{x:(e=t).x+n.x,y:e.y+n.y,w:e.w,h:e.h}))}return u=[{name:"move",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:0,deltaH:0,label:"Crop Mask"},{name:"nw",xMul:0,yMul:0,deltaX:1,deltaY:1,deltaW:-1,deltaH:-1,label:"Top Left Crop Handle"},{name:"ne",xMul:1,yMul:0,deltaX:0,deltaY:1,deltaW:1,deltaH:-1,label:"Top Right Crop Handle"},{name:"sw",xMul:0,yMul:1,deltaX:1,deltaY:0,deltaW:-1,deltaH:1,label:"Bottom Left Crop Handle"},{name:"se",xMul:1,yMul:1,deltaX:0,deltaY:0,deltaW:1,deltaH:1,label:"Bottom Right Crop Handle"}],l=["top","right","bottom","left"],rt('<div id="'+f+'" class="'+s+'croprect-container" role="grid" aria-dropeffect="execute">').appendTo(r),e.each(l,(function(t){rt("#"+f,r).append('<div id="'+f+"-"+t+'"class="'+s+'croprect-block" style="display: none" data-mce-bogus="all">')})),e.each(u,(function(t){rt("#"+f,r).append('<div id="'+f+"-"+t.name+'" class="'+s+"croprect-handle "+s+"croprect-handle-"+t.name+'"style="display: none" data-mce-bogus="all" role="gridcell" tabindex="-1" aria-label="'+t.label+'" aria-grabbed="false">')})),c=e.map(u,(function(n){var e;return new(et.get("DragHelper"))(f,{document:r.ownerDocument,handle:f+"-"+n.name,start:function(){e=t},drag:function(t){h(n,e,t.deltaX,t.deltaY)}})})),p(t),rt(r).on("focusin focusout",(function(t){rt(t.target).attr("aria-grabbed","focus"===t.type)})),rt(r).on("keydown",(function(n){var o;function r(t,n,e,r,i){t.stopPropagation(),t.preventDefault(),h(o,e,r,i)}switch(e.each(u,(function(t){if(n.target.id===f+"-"+t.name)return o=t,!1})),n.keyCode){case at.LEFT:r(n,0,t,-10,0);break;case at.RIGHT:r(n,0,t,10,0);break;case at.UP:r(n,0,t,0,-10);break;case at.DOWN:r(n,0,t,0,10);break;case at.ENTER:case at.SPACEBAR:n.preventDefault(),i()}})),a=e.extend({toggleVisibility:function(t){var n;n=e.map(u,(function(t){return"#"+f+"-"+t.name})).concat(e.map(l,(function(t){return"#"+f+"-"+t}))).join(","),t?rt(n,r).show():rt(n,r).hide()},setClampRect:function(n){o=n,p(t)},setRect:m,getInnerRect:function(){return d(o,t)},setInnerRect:g,setViewPortRect:function(e){n=e,p(t)},destroy:function(){e.each(c,(function(t){t.destroy()})),c=[]}},it)}(n,t.state.get("viewRect"),t.state.get("viewRect"),t.getEl(),(function(){t.fire("crop")})),t.cropRect.on("updateRect",(function(n){var e=n.rect,o=t.zoom();e={x:Math.round(e.x/o),y:Math.round(e.y/o),w:Math.round(e.w/o),h:Math.round(e.h/o)},t.state.set("rect",e)})),t.on("remove",t.cropRect.destroy)}t.state.on("change:cropEnabled",(function(n){t.cropRect.toggleVisibility(n.value),t.repaintImage()})),t.state.on("change:zoom",(function(){t.repaintImage()})),t.state.on("change:rect",(function(e){var o=e.value;t.cropRect||n(o),t.cropRect.setRect(o)}))}}))(t)}({flex:1,imageSrc:n.url}),h=et.create("Container",{layout:"flex",direction:"column",pack:"start",border:"0 1 0 0",padding:5,spacing:5,items:[{type:"button",icon:"undo",tooltip:"Undo",name:"undo",onclick:function(){H(n=_.undo()),O()}},{type:"button",icon:"redo",tooltip:"Redo",name:"redo",onclick:function(){H(n=_.redo()),O()}},{type:"button",icon:"zoomin",tooltip:"Zoom in",onclick:function(){var t=d.zoom();t<2&&(t+=.1),d.zoom(t)}},{type:"button",icon:"zoomout",tooltip:"Zoom out",onclick:function(){var t=d.zoom();t>.1&&(t-=.1),d.zoom(t)}}]}),p=et.create("Container",{type:"container",layout:"flex",direction:"row",align:"stretch",flex:1,items:z([h,d])}),M=[a,l,s,f,u,m,g,v,y,b,w,x,k,R,T,I,C],(i=t.windowManager.open({layout:"flex",direction:"column",align:"stretch",minWidth:Math.min(nt.DOM.getViewPort().w,800),minHeight:Math.min(nt.DOM.getViewPort().h,650),title:"Edit image",items:M.concat([p]),buttons:z([{text:"Save",name:"save",subtype:"primary",onclick:function(){o(n.blob),i.close()}},{text:"Cancel",onclick:"close"}])})).on("close",(function(){r(),st(_.data),_=null,c=null})),_.add(n),O(),d.on("load",(function(){B=d.imageSize().w,A=d.imageSize().h,U=A/B,E=B/A,i.find("#w").value(B),i.find("#h").value(A)})),d.on("crop",V)}var dt=function(t){var n,e;function o(t){return/^[0-9\.]+px$/.test(t)}return n=t.style.width,e=t.style.height,n||e?o(n)&&o(e)?{w:parseInt(n,10),h:parseInt(e,10)}:null:(n=t.width,e=t.height,n&&e?{w:parseInt(n,10),h:parseInt(e,10)}:null)},ht=function(t){return{w:t.naturalWidth,h:t.naturalHeight}},pt=(Array.prototype.indexOf,Array.prototype.push,Array.prototype.slice,function(t,n){for(var e=0,o=t.length;e<o;e++){var r=t[e];if(n(r,e,t))return x.some(r)}return x.none()}),mt=function(t){return null!=t},gt=function(t,n){return new Q((function(o){var r;(r=new function(){return new(R("XMLHttpRequest"))}).onreadystatechange=function(){4===r.readyState&&o({status:r.status,blob:this.response})},r.open("GET",t,!0),e.each(n,(function(t,n){r.setRequestHeader(n,t)})),r.responseType="blob",r.send()}))},vt=[{code:404,message:"Could not find Image Proxy"},{code:403,message:"Rejected request"},{code:0,message:"Incorrect Image Proxy URL"}],yt=[{type:"key_missing",message:"The request did not include an api key."},{type:"key_not_found",message:"The provided api key could not be found."},{type:"domain_not_trusted",message:"The api key is not valid for the request origins."}],bt=function(t){var n=function(t){return"ImageProxy HTTP error: "+pt(vt,(function(n){return t===n.code})).fold(m.constant("Unknown ImageProxy error"),(function(t){return t.message}))}(t);return Q.reject(n)},wt=function(t,n){return 400===(e=t)||403===e||500===e?function(t,n){return function(t){return new Q((function(n){var e=new T;e.onload=function(t){var e=t.target;n(e.result)},e.readAsText(t)}))}(n).then((function(t){var n,e,o=(n=function(t){var n;try{n=JSON.parse(t)}catch(t){}return n}(t),"ImageProxy Service error: "+((e=function(t,n){var e;return e=n.reduce((function(t,n){return mt(t)?t[n]:void 0}),t),mt(e)?e:null}(n,["error","type"]))?function(t){return pt(yt,(function(n){return n.type===t})).fold(m.constant("Unknown service error"),(function(t){return t.message}))}(e):"Invalid JSON in service error message"));return Q.reject(o)}))}(0,n):bt(t);var e},xt=bt,kt=function(t,n){return n?function(t,n){return gt((e=t,o=n,r=-1===e.indexOf("?")?"?":"&",/[?&]apiKey=/.test(e)||!o?e:e+r+"apiKey="+encodeURIComponent(o)),{"Content-Type":"application/json;charset=UTF-8","tiny-api-key":n}).then((function(t){return t.status<200||t.status>=300?wt(t.status,t.blob):Q.resolve(t.blob)}));var e,o,r}(t,n):gt(t,{}).then((function(t){return t.status<200||t.status>=300?xt(t.status):Q.resolve(t.blob)}))},Rt=0,Tt=function(t,n){t.notificationManager.open({text:n,type:"error"})},It=function(t){return t.selection.getNode()},Ct=function(t,n){var e=n.src;return 0===e.indexOf("data:")||0===e.indexOf("blob:")||new tt(e).host===t.documentBaseURI.host},Mt=function(t,n){return-1!==e.inArray(t.settings.imagetools_cors_hosts,new tt(n.src).host)},Bt=function(t){var n,e,o,r,i,a;return(n=t.editorUpload.blobCache.getByUri(It(t).src))?Q.resolve(n.blob()):(e=t,a=(o=It(t)).src,Mt(e,o)?kt(o.src,null):Ct(e,o)?function(t){return U.imageToBlob(t)}(o):(a=function(t){return t.getParam("imagetools_proxy")}(e),a+=(-1===a.indexOf("?")?"?":"&")+"url="+encodeURIComponent(o.src),r=(i=e).settings.api_key||i.settings.imagetools_api_key,kt(a,r)))},At=function(t){clearTimeout(t.get())},Ut=function(t,n,e,o,r){return n.toBlob().then((function(i){var a,u,c,l,s,f,d;return c=t.editorUpload.blobCache,a=(s=It(t)).src,t.settings.images_reuse_filename&&((l=c.getByUri(a))?(a=l.uri(),u=l.name()):(f=t,u=(d=a.match(/\/([^\/\?]+)?\.(?:jpeg|jpg|png|gif)(?:\?|$)/i))?f.dom.encode(d[1]):null)),l=c.create({id:"imagetools"+Rt++,blob:i,base64:n.toBase64(),uri:a,name:u}),c.add(l),t.undoManager.transact((function(){t.$(s).on("load",(function n(){t.$(s).off("load",n),t.nodeChanged(),e?t.editorUpload.uploadImagesAuto():(At(o),function(t,n){var e=Z.setEditorTimeout(t,(function(){t.editorUpload.uploadImagesAuto()}),t.settings.images_upload_timeout||3e4);n.set(e)}(t,o))})),r&&t.$(s).attr({width:r.w,height:r.h}),t.$(s).attr({src:l.blobUri()}).removeAttr("data-mce-src")})),l}))},Et=function(t,n,e,o){return function(){return t._scanForImages().then(m.curry(Bt,t)).then(Y).then(e).then((function(e){return Ut(t,e,!1,n,o)}),(function(n){Tt(t,n)}))}},_t=function(t,n,e){return function(){var o=dt(It(t)),r=o?{w:o.h,h:o.w}:null;return Et(t,n,(function(t){return X.rotate(t,e)}),r)()}},zt=function(t,n,e){return function(){return Et(t,n,(function(t){return X.flip(t,e)}))()}},Dt=function(t,n){return function(){var e=It(t),o=ht(e),r=function(t){return new Q((function(n){(function(t){return U.blobToImage(t)})(t).then((function(r){var i=ht(r);o.w===i.w&&o.h===i.h||dt(e)&&function(t,n){var e,o;n&&(e=t.style.width,o=t.style.height,(e||o)&&(t.style.width=n.w+"px",t.style.height=n.h+"px",t.removeAttribute("data-mce-style")),e=t.width,o=t.height,(e||o)&&(t.setAttribute("width",n.w),t.setAttribute("height",n.h)))}(e,i),J(r.src),n(t)}))}))};Bt(t).then(Y).then(m.curry((function(t,e){return function(t,n){return new Q((function(e,o){return n.toBlob().then((function(n){ft(t,ct(n),e,o)}))}))}(t,e).then(r).then(Y).then((function(e){return Ut(t,e,!0,n)}),(function(){}))}),t),(function(n){Tt(t,n)}))}},Lt=function(t,n){return t.dom.is(n,"img:not([data-mce-object],[data-mce-placeholder])")&&(Ct(t,n)||Mt(t,n)||t.settings.imagetools_proxy)},Ot=At,jt=function(t,n){e.each({mceImageRotateLeft:_t(t,n,-90),mceImageRotateRight:_t(t,n,90),mceImageFlipVertical:zt(t,n,"v"),mceImageFlipHorizontal:zt(t,n,"h"),mceEditImage:Dt(t,n)},(function(n,e){t.addCommand(e,n)}))};n.add("imagetools",(function(n){var e=t(0),o=t(null);jt(n,e),function(t){t.addButton("rotateleft",{title:"Rotate counterclockwise",cmd:"mceImageRotateLeft"}),t.addButton("rotateright",{title:"Rotate clockwise",cmd:"mceImageRotateRight"}),t.addButton("flipv",{title:"Flip vertically",cmd:"mceImageFlipVertical"}),t.addButton("fliph",{title:"Flip horizontally",cmd:"mceImageFlipHorizontal"}),t.addButton("editimage",{title:"Edit image",cmd:"mceEditImage"}),t.addButton("imageoptions",{title:"Image options",icon:"options",cmd:"mceImage"})}(n),function(t){t.addContextToolbar(m.curry(Lt,t),function(t){return t.getParam("imagetools_toolbar","rotateleft rotateright | flipv fliph | crop editimage imageoptions")}(t))}(n),function(t,n,e){t.on("NodeChange",(function(o){var r=e.get();r&&r.src!==o.element.src&&(Ot(n),t.editorUpload.uploadImagesAuto(),e.set(null)),Lt(t,o.element)&&e.set(o.element)}))}(n,e,o)}))}();